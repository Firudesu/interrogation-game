<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interrogation Simulator 2000 - Enhanced Edition</title>
    <style>
        body {
            background: linear-gradient(135deg, #008080 0%, #006666 50%, #004444 100%);
            margin: 0;
            padding: 0;
            font-family: 'MS Sans Serif', 'Tahoma', sans-serif;
            color: #000;
            height: 100vh;
            overflow: hidden;
            position: relative;
            background-image: url('carboardboxel_create_me_a_image_of_a_police_integration_room__350484e5-14b6-4d21-877f-9d20dddf85af_3.png');
            background-size: cover;
            background-blend-mode: multiply;
        }

        /* Enhanced CRT effects */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.15) 0px,
                    rgba(0, 0, 0, 0.15) 1px,
                    transparent 1px,
                    transparent 3px
                ),
                repeating-linear-gradient(
                    90deg,
                    rgba(255, 0, 0, 0.03),
                    rgba(0, 255, 0, 0.02),
                    rgba(0, 0, 255, 0.03)
                );
            pointer-events: none;
            z-index: 999;
            animation: scanlines 2s linear infinite;
        }

        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                ellipse at center,
                rgba(0, 255, 0, 0.08) 0%,
                rgba(0, 255, 0, 0.02) 40%,
                rgba(0, 0, 0, 0.1) 100%
            );
            pointer-events: none;
            animation: crtFlicker 0.15s infinite linear alternate;
        }

        .desktop {
            display: flex;
            height: 100vh;
            width: 100vw;
            box-sizing: border-box;
            filter: contrast(1.1) brightness(0.95);
        }

        .left-panel {
            width: 60%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
        }

        .right-panel {
            position: fixed;
            right: 15px;
            top: 15px;
            width: 38%;
            height: 45%;
            min-width: 320px;
        }

        .window {
            background: linear-gradient(145deg, #d4d0c8 0%, #c0c0c0 50%, #a8a8a8 100%);
            border: 2px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
            box-shadow: 
                inset 1px 1px 0px rgba(255, 255, 255, 0.8),
                inset -1px -1px 0px rgba(0, 0, 0, 0.2),
                4px 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
            border-radius: 0;
        }

        .right-panel .window {
            resize: both;
            overflow: auto;
            width: 100%;
            height: 100%;
            min-width: 320px;
            min-height: 240px;
        }

        #crimeSummary {
            height: 32vh;
            font-size: 12px;
        }

        #chatLog {
            height: 250px;
            max-height: 250px;
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            border: 2px inset #c0c0c0;
            padding: 8px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .live-feed {
            height: 100%;
            width: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 20, 0, 0.8) 100%);
            border: 2px inset #808080;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            padding: 12px;
            animation: monitorFlicker 0.1s infinite;
            background-image: url('https://cdn.midjourney.com/350484e5-14b6-4d21-877f-9d20dddf85af/0_3.png');
            background-size: cover;
            background-position: center;
            background-blend-mode: multiply;
            box-sizing: border-box;
            position: relative;
            font-size: 11px;
            text-shadow: 0 0 5px #00ff41;
        }

        .title-bar {
            background: linear-gradient(90deg, #000080 0%, #0000a0 50%, #000080 100%);
            color: white;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #404040;
            font-weight: bold;
            font-size: 11px;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.5);
        }

        .window-content {
            padding: 10px;
            overflow-y: auto;
            max-height: calc(100% - 32px);
            font-size: 11px;
            line-height: 1.4;
        }

        .right-panel .window-content {
            padding: 10px;
        }

        #taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #d4d0c8 0%, #c0c0c0 50%, #a8a8a8 100%);
            border-top: 2px solid #ffffff;
            border-bottom: 1px solid #404040;
            padding: 3px;
            display: flex;
            gap: 6px;
            height: 32px;
            z-index: 1000;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.2);
        }

        .taskbar-button {
            background: linear-gradient(145deg, #d4d0c8 0%, #c0c0c0 50%, #a8a8a8 100%);
            border: 1px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
            padding: 4px 12px;
            font-size: 11px;
            cursor: pointer;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .taskbar-button:active {
            border-color: #404040 #ffffff #ffffff #404040;
            background: linear-gradient(145deg, #a8a8a8 0%, #c0c0c0 50%, #d4d0c8 100%);
        }

        .stress-indicator {
            width: 120px;
            height: 16px;
            border: 2px inset #c0c0c0;
            background: #000;
            margin: 8px 0;
            position: relative;
        }

        .stress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00 0%, #ffff00 50%, #ff0000 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        #caseFile, #suspectFile, #evidenceFile {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 65vw;
            max-height: 75vh;
            z-index: 1001;
            display: none;
            box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }

        #caseFileContent, #suspectFileContent, #evidenceFileContent {
            max-height: calc(75vh - 40px);
            overflow-y: auto;
            padding: 10px;
        }

        .verdict-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #d4d0c8 0%, #c0c0c0 50%, #a8a8a8 100%);
            border: 2px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
            padding: 20px;
            z-index: 1002;
            width: 450px;
            display: none;
            box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.4);
        }

        .draggable {
            cursor: move;
            user-select: none;
        }

        .evidence-list, .suspect-info {
            list-style-type: none;
            padding-left: 0;
            margin: 8px 0;
        }

        .evidence-list li, .suspect-info li {
            margin: 4px 0;
            padding: 4px 8px;
            background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
            border: 1px solid;
            border-color: #404040 #ffffff #ffffff #404040;
            font-size: 10px;
        }

        .lives-container {
            margin-left: auto;
            display: flex;
            gap: 6px;
            padding-right: 15px;
            align-items: center;
        }

        .life-badge {
            width: 28px;
            height: 28px;
            background: radial-gradient(circle, #000080 0%, #000060 100%);
            border: 2px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
            border-radius: 50%;
            position: relative;
        }

        .life-badge::after {
            content: "👮";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        .life-badge.lost {
            background: radial-gradient(circle, #800000 0%, #400000 100%);
            filter: grayscale(100%) brightness(40%);
        }

        .life-badge.lost::after {
            content: "💀";
        }

        .intro-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1003;
            width: 500px;
            box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.5);
        }

        .game-over {
            color: #ff0000;
            font-size: 18px;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.5);
        }

        .verdict-buttons {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .verdict-button {
            background: linear-gradient(145deg, #d4d0c8 0%, #c0c0c0 50%, #a8a8a8 100%);
            border: 2px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
            padding: 8px 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .verdict-button:active {
            border-color: #404040 #ffffff #ffffff #404040;
            background: linear-gradient(145deg, #a8a8a8 0%, #c0c0c0 50%, #d4d0c8 100%);
        }

        .next-case-button {
            display: none;
            margin-top: 20px;
            width: 100%;
            background: linear-gradient(145deg, #d4d0c8 0%, #c0c0c0 50%, #a8a8a8 100%);
            border: 2px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .verdict-result {
            min-height: 80px;
            text-align: center;
            font-weight: bold;
            padding: 10px;
        }

        .personality-indicator {
            background: rgba(0, 0, 0, 0.7);
            color: #00ff41;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #00ff41;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        .question-input-container {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            align-items: center;
            background: #c0c0c0;
            padding: 8px;
            border: 2px inset #c0c0c0;
            border-radius: 2px;
        }

        #questionInput {
            flex: 1;
            background: #ffffff;
            border: 2px inset #c0c0c0;
            padding: 6px;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 12px;
            min-height: 20px;
        }

        .ask-button {
            background: linear-gradient(145deg, #d4d0c8 0%, #c0c0c0 50%, #a8a8a8 100%);
            border: 2px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
            padding: 6px 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'MS Sans Serif', sans-serif;
            min-height: 32px;
        }

        .ask-button:active {
            border-color: #404040 #ffffff #ffffff #404040;
            background: linear-gradient(145deg, #a8a8a8 0%, #c0c0c0 50%, #d4d0c8 100%);
        }

        .chat-message {
            margin: 4px 0;
            padding: 2px 0;
        }

        .chat-message.user {
            color: #ffff00;
        }

        .chat-message.suspect {
            color: #00ff00;
        }

        .chat-message.system {
            color: #ff6600;
            font-style: italic;
        }

        @keyframes scanlines {
            0% { background-position: 0 0; }
            100% { background-position: 0 3px; }
        }

        @keyframes crtFlicker {
            0% { opacity: 1; }
            98% { opacity: 1; }
            99% { opacity: 0.98; }
            100% { opacity: 1; }
        }

        @keyframes monitorFlicker {
            0% { opacity: 0.95; }
            50% { opacity: 1; }
            100% { opacity: 0.95; }
        }

        ::-webkit-scrollbar {
            width: 16px;
        }

        ::-webkit-scrollbar-track {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, #d4d0c8 0%, #a8a8a8 100%);
            border: 2px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
        }

        ::-webkit-scrollbar-thumb:active {
            background: linear-gradient(145deg, #a8a8a8 0%, #d4d0c8 100%);
        }
    </style>
</head>
<body>
    <div class="desktop">
        <div class="left-panel">
            <div class="window">
                <div class="title-bar">📋 Case Overview - Classified</div>
                <div class="window-content" id="crimeSummary"></div>
            </div>
            
            <div class="window">
                <div class="title-bar">🎤 Interrogation Console - Live Session</div>
                <div class="window-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span>⏰ Time: <span id="timer">10:00</span></span>
                        <span>📊 Stress: <span id="stressLevel">0</span>%</span>
                        <span>🎯 Phase: <span id="interrogationPhase">1</span></span>
                    </div>
                    <div class="stress-indicator">
                        <div class="stress-fill" id="stressFill"></div>
                    </div>
                    <div class="personality-indicator" id="personalityIndicator"></div>
                    <div id="chatLog"></div>
                    <div class="question-input-container">
                        <input type="text" id="questionInput" placeholder="Enter your question..." maxlength="200">
                        <button class="ask-button" onclick="askQuestion()">ASK</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="window">
                <div class="title-bar">📹 Suspect Monitor - Room 3A</div>
                <div class="window-content live-feed">
                    <div id="suspectCam"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="taskbar">
        <button class="taskbar-button" onclick="toggleCaseFile()">📁 Case File</button>
        <button class="taskbar-button" onclick="toggleSuspectFile()">👤 Suspect File</button>
        <button class="taskbar-button" onclick="toggleEvidenceFile()">🔍 Evidence</button>
        <div class="lives-container">
            <div class="life-badge" id="life1"></div>
            <div class="life-badge" id="life2"></div>
            <div class="life-badge" id="life3"></div>
        </div>
    </div>

    <!-- File Windows -->
    <div class="window" id="caseFile">
        <div class="title-bar draggable">
            📋 Case File - Confidential
            <button onclick="toggleCaseFile()" style="margin-left:auto">✖</button>
        </div>
        <div class="window-content" id="caseFileContent"></div>
    </div>

    <div class="window" id="suspectFile">
        <div class="title-bar draggable">
            👤 Suspect Profile - Database Record
            <button onclick="toggleSuspectFile()" style="margin-left:auto">✖</button>
        </div>
        <div class="window-content" id="suspectFileContent"></div>
    </div>

    <div class="window" id="evidenceFile">
        <div class="title-bar draggable">
            🔍 Evidence Locker - Chain of Custody
            <button onclick="toggleEvidenceFile()" style="margin-left:auto">✖</button>
        </div>
        <div class="window-content" id="evidenceFileContent"></div>
    </div>

    <!-- Popups -->
    <div class="window intro-popup" id="introPopup">
        <div class="title-bar draggable">
            🚔 OFFICIAL POLICE BRIEFING - CLASSIFIED
            <button onclick="startGame()" style="margin-left:auto">✖</button>
        </div>
        <div class="window-content">
            <p style="text-align: center; font-weight: bold; color: #000080;">ENHANCED INTERROGATION SIMULATOR</p>
            <p style="color: #ff0000; font-weight: bold;">⚠️ SECURITY CLEARANCE REQUIRED ⚠️</p>
            <p>You are authorized to conduct <strong>enhanced interrogations</strong> with advanced psychological profiling.</p>
            <p><strong>Mission Parameters:</strong></p>
            <ul>
                <li>Maximum 3 incorrect determinations permitted</li>
                <li>Suspects may exhibit complex behavioral patterns</li>
                <li>Advanced AI personality simulation active</li>
                <li>Psychological slip-up detection enabled</li>
            </ul>
            <p style="color: #800000;"><strong>WARNING:</strong> Suspects are now equipped with enhanced deception capabilities.</p>
            <div style="text-align: center; margin-top: 20px;">
                <button class="verdict-button" onclick="startGame()">🎯 BEGIN ENHANCED INTERROGATION</button>
            </div>
        </div>
    </div>

    <div class="window verdict-dialog" id="gameOverScreen" style="display: none;">
        <div class="title-bar">🚨 SYSTEM ALERT - MISSION FAILURE</div>
        <div class="window-content">
            <div class="game-over">MISSION TERMINATED</div>
            <div>You have exceeded the maximum allowed incorrect determinations.</div>
            <div style="margin: 15px 0;">Your security clearance has been revoked.</div>
            <div style="text-align:center">
                <button class="verdict-button" onclick="location.reload()">🔄 REQUEST NEW CLEARANCE</button>
            </div>
        </div>
    </div>

    <div class="verdict-dialog" id="verdictDialog">
        <div class="title-bar">⚖️ INTERROGATION ASSESSMENT</div>
        <div class="window-content">
            <div style="margin: 15px 0; font-size: 12px;">
                <strong>Final Assessment:</strong><br>
                Stress Level: <span id="finalStress">0</span>%<br>
                Behavioral Markers: <span id="finalContradictions">0</span><br>
                Interrogation Phase: <span id="finalPhase">1</span><br>
                Personality Type: <span id="finalPersonality">Unknown</span>
            </div>
            <div class="verdict-result" id="verdictResult"></div>
            <div class="verdict-buttons" id="activeVerdictButtons">
                <button class="verdict-button" onclick="checkVerdict(true)">⚖️ GUILTY</button>
                <button class="verdict-button" onclick="checkVerdict(false)">✅ INNOCENT</button>
            </div>
            <button class="next-case-button" id="nextCaseButton" onclick="handleNextCase()">➡️ NEXT CASE</button>
        </div>
    </div>

    <script>
        // Enhanced crime scenarios with more variety and detail
        const CRIME_TEMPLATES = [
            {
                type: "Armed Robbery",
                locations: ["First National Bank", "Corner Convenience Store", "Downtown Jewelry Shop", "Gas Station", "Pharmacy"],
                motives: ["Gambling debts", "Drug addiction", "Desperate for rent money", "Supporting sick family member", "Gang initiation"],
                evidence: ["Security footage", "Fingerprints on weapon", "Witness testimony", "DNA evidence", "Cell phone records"],
                timeFrames: ["early morning", "late evening", "during lunch rush", "closing time", "weekend night"]
            },
            {
                type: "Homicide",
                locations: ["Victim's apartment", "Dark alley", "Office building", "Parking garage", "Abandoned warehouse"],
                motives: ["Insurance money", "Love triangle", "Business dispute", "Revenge", "Silencing witness"],
                evidence: ["Murder weapon", "Blood spatter analysis", "Victim's phone records", "CCTV footage", "Forensic evidence"],
                timeFrames: ["late at night", "early morning", "during work hours", "weekend evening", "holiday night"]
            },
            {
                type: "Kidnapping",
                locations: ["School parking lot", "Shopping mall", "Residential street", "Office parking garage", "Public park"],
                motives: ["Ransom demand", "Custody dispute", "Human trafficking", "Personal vendetta", "Mistaken identity"],
                evidence: ["Ransom note", "Vehicle description", "Witness accounts", "Phone trace", "Security camera footage"],
                timeFrames: ["after school", "during shopping", "morning jog", "late evening", "weekend afternoon"]
            },
            {
                type: "Burglary",
                locations: ["Suburban home", "Luxury apartment", "Office building", "Electronics store", "Art gallery"],
                motives: ["Quick cash", "Specific valuable item", "Inside information", "Thrill seeking", "Feeding addiction"],
                evidence: ["Forced entry marks", "Stolen items list", "Fingerprints", "Neighbor testimony", "Alarm system logs"],
                timeFrames: ["during work hours", "vacation absence", "late night", "early morning", "weekend"]
            }
        ];

        // Enhanced personality types with detailed behavioral patterns
        const PERSONALITY_TYPES = [
            {
                name: "Narcissistic Manipulator",
                traits: ["Charming", "Arrogant", "Blame-shifting", "Grandiose"],
                guiltyBehavior: ["Tries to charm interrogator", "Minimizes crimes", "Blames victims", "Shows no remorse"],
                innocentBehavior: ["Offended by accusations", "Demands respect", "Threatens legal action", "Name-drops connections"],
                slipUpTriggers: ["Challenging their intelligence", "Questioning their status", "Comparing to others"],
                stressResponses: ["Becomes more aggressive", "Starts threatening", "Loses composure", "Reveals narcissistic rage"]
            },
            {
                name: "Anxious Pleaser",
                traits: ["Nervous", "Apologetic", "Seeks approval", "Self-doubting"],
                guiltyBehavior: ["Over-explains", "Contradicts self", "Seeks forgiveness", "Confesses to lesser crimes"],
                innocentBehavior: ["Desperately wants to help", "Provides too much detail", "Asks if they're doing okay", "Worries about wasting time"],
                slipUpTriggers: ["Pressure to remember details", "Fear of disappointing", "Anxiety about consequences"],
                stressResponses: ["Stammers more", "Fidgets excessively", "Seeks reassurance", "May have panic attacks"]
            },
            {
                name: "Cold Calculator",
                traits: ["Emotionless", "Logical", "Precise", "Detached"],
                guiltyBehavior: ["Gives minimal answers", "Shows no emotion", "Calculates responses", "Reveals nothing extra"],
                innocentBehavior: ["Methodically explains", "Provides precise timelines", "Asks logical questions", "Remains calm"],
                slipUpTriggers: ["Emotional manipulation", "Illogical accusations", "Time pressure"],
                stressResponses: ["Becomes more robotic", "Starts calculating odds", "Shows micro-expressions", "Logic breaks down"]
            },
            {
                name: "Defensive Aggressor",
                traits: ["Hostile", "Confrontational", "Victim-blaming", "Explosive"],
                guiltyBehavior: ["Attacks interrogator", "Deflects with anger", "Threatens consequences", "Shows contempt"],
                innocentBehavior: ["Righteous anger", "Demands justice", "Frustrated by process", "Wants real criminal caught"],
                slipUpTriggers: ["Direct accusations", "Questioning their character", "Mentioning victims"],
                stressResponses: ["Explosive outbursts", "Physical aggression", "Verbal attacks", "Reveals information in anger"]
            },
            {
                name: "Broken Victim",
                traits: ["Traumatized", "Withdrawn", "Self-destructive", "Hopeless"],
                guiltyBehavior: ["Accepts blame readily", "Shows genuine remorse", "Wants punishment", "Confesses easily"],
                innocentBehavior: ["Defeated by system", "Expects worst outcome", "Doesn't fight accusations", "Resigned to fate"],
                slipUpTriggers: ["Kindness", "Understanding", "Mention of family"],
                stressResponses: ["Emotional breakdown", "Self-harm threats", "Complete shutdown", "Dissociation"]
            }
        ];

        const SUSPECT_NAMES = [
            "Marcus Thompson", "Sarah Williams", "David Chen", "Maria Rodriguez", "James Patterson",
            "Lisa Anderson", "Michael Johnson", "Jennifer Davis", "Robert Miller", "Amanda Wilson",
            "Christopher Lee", "Michelle Brown", "Daniel Garcia", "Jessica Moore", "Anthony Taylor",
            "Ashley Martinez", "Kevin White", "Nicole Jackson", "Steven Harris", "Melissa Clark",
            "Brian Lewis", "Stephanie Walker", "Jason Hall", "Kimberly Allen", "Matthew Young",
            "Rebecca King", "Ryan Wright", "Laura Lopez", "Nicholas Green", "Samantha Adams",
            "Tyler Baker", "Christina Nelson", "Jonathan Hill", "Rachel Carter", "Brandon Mitchell",
            "Heather Perez", "Jacob Roberts", "Megan Turner", "Alexander Phillips", "Tiffany Campbell",
            "Nathan Parker", "Vanessa Evans", "Zachary Edwards", "Brittany Collins", "Gregory Stewart",
            "Danielle Sanchez", "Jeremy Morris", "Kristen Rogers", "Sean Reed", "Amber Cook"
        ];

        let gameState = {
            lives: 3,
            crime: null,
            suspect: null,
            contradictions: 0,
            stress: 0,
            timer: 600, // 10 minutes
            chatHistory: [],
            interrogationPhase: 1,
            personalityType: null,
            slipUpCount: 0,
            evidenceRevealed: [],
            suspectKnowledge: null
        };

        // Enhanced AI query function with different request types
        async function queryChatGPT(prompt, requestType = 'interrogation', context = {}) {
            try {
                const requestData = {
                    prompt: prompt,
                    requestType: requestType,
                    context: context,
                    isGuilty: gameState.suspect?.isGuilty || false,
                    suspectProfile: gameState.suspect?.profile || "",
                    crimeDetails: gameState.suspect?.isGuilty ? gameState.suspectKnowledge : null,
                    chatHistory: gameState.chatHistory.slice(-5), // Last 5 exchanges for context
                    stressLevel: gameState.stress,
                    interrogationPhase: gameState.interrogationPhase
                };

                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.content;
            } catch (error) {
                console.error('API Error:', error);
                return generateFallbackResponse(prompt);
            }
        }

        // Fallback response system for when API fails
        function generateFallbackResponse(question) {
            const fallbacks = [
                "I... I don't know what you're talking about.",
                "Look, I already told you everything I know.",
                "Why are you asking me this?",
                "I want a lawyer.",
                "This is harassment!",
                "I was nowhere near there.",
                "You can't prove anything.",
                "I don't remember.",
                "That's not what happened.",
                "Someone's lying to you."
            ];
            return fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }

        // Enhanced crime generation with templates
        async function generateEnhancedCrime() {
            const template = CRIME_TEMPLATES[Math.floor(Math.random() * CRIME_TEMPLATES.length)];
            const location = template.locations[Math.floor(Math.random() * template.locations.length)];
            const motive = template.motives[Math.floor(Math.random() * template.motives.length)];
            const timeFrame = template.timeFrames[Math.floor(Math.random() * template.timeFrames.length)];
            
            const evidenceItems = [];
            for (let i = 0; i < 4; i++) {
                const evidence = template.evidence[Math.floor(Math.random() * template.evidence.length)];
                if (!evidenceItems.includes(evidence)) {
                    evidenceItems.push(evidence);
                }
            }

            const caseNumber = `2024-${String(Math.floor(Math.random() * 999999)).padStart(6, '0')}`;
            
            const crimePrompt = `Generate a detailed police case file for a ${template.type} that occurred at ${location} during ${timeFrame}.

            Case Details:
            - Case Number: ${caseNumber}
            - Crime Type: ${template.type}
            - Location: ${location}
            - Motive: ${motive}
            - Time Frame: ${timeFrame}
            - Evidence Available: ${evidenceItems.join(', ')}

            Create a comprehensive case file with:
            1. CASE SUMMARY (150-200 words with specific times, dates, and details)
            2. INCIDENT TIMELINE (hour-by-hour breakdown)
            3. PHYSICAL EVIDENCE (detailed descriptions of each evidence item)
            4. WITNESS STATEMENTS (2-3 detailed witness accounts with names and contact info)
            5. SUSPECT INFORMATION (preliminary details about primary suspect)
            6. INVESTIGATIVE NOTES (detective observations and theories)

            Make it realistic with specific details, addresses, times, and procedural information. Format professionally as an official police document.`;

            return await queryChatGPT(crimePrompt, 'case_generation');
        }

                 // Enhanced suspect generation with personality integration and pressure points
         async function generateEnhancedSuspect(name) {
             const isGuilty = Math.random() > 0.4; // 60% chance of guilt for more interesting gameplay
             const personalityType = PERSONALITY_TYPES[Math.floor(Math.random() * PERSONALITY_TYPES.length)];
             
             // Generate dark secrets/pressure points for all suspects
             const darkSecrets = [
                 "Has gambling addiction and owes money to dangerous people",
                 "Had an affair that could destroy their marriage",
                 "Has been embezzling money from their employer",
                 "Has a history of domestic violence they've hidden",
                 "Is illegally in the country and fears deportation",
                 "Has been selling drugs to pay for medical bills",
                 "Was abused as a child and has violent tendencies",
                 "Has been lying about their education/credentials",
                 "Has a restraining order against them from an ex",
                 "Has been stealing from family members",
                 "Has a serious mental illness they're hiding",
                 "Has been involved in insurance fraud",
                 "Has a criminal record they've been hiding",
                 "Has been blackmailing someone",
                 "Has been involved in tax evasion"
             ];
             
             const suspectHistory = [
                 "Previously arrested for shoplifting as a teenager",
                 "Has a history of bar fights and public intoxication",
                 "Was fired from previous job for misconduct",
                 "Has been in rehab multiple times for addiction",
                 "Has a history of restraining orders",
                 "Previously investigated for fraud but not charged",
                 "Has been evicted multiple times for non-payment",
                 "Has a history of mental health hospitalizations",
                 "Previously arrested for driving under the influence",
                 "Has been involved in multiple civil lawsuits",
                 "Has a history of workplace harassment complaints",
                 "Previously investigated for domestic violence",
                 "Has been arrested for public disturbance",
                 "Has a history of financial problems and bankruptcy",
                 "Previously caught lying on official documents"
             ];
             
             const selectedSecret = darkSecrets[Math.floor(Math.random() * darkSecrets.length)];
             const selectedHistory = suspectHistory[Math.floor(Math.random() * suspectHistory.length)];
             
             const profilePrompt = `Create a detailed psychological profile for suspect ${name} with the following personality type: ${personalityType.name}

             Personality Traits: ${personalityType.traits.join(', ')}
             
             IMPORTANT: This suspect has the following background elements that create stress when mentioned:
             - Dark Secret/Pressure Point: ${selectedSecret}
             - Criminal/Personal History: ${selectedHistory}
             
             Include:
             1. BASIC INFORMATION (Name, Age, Sex, Height, Weight, Build)
             2. PHYSICAL DESCRIPTION (Hair, Eyes, Distinguishing marks, Clothing style)
             3. PSYCHOLOGICAL PROFILE (Personality traits, behavioral patterns, triggers)
             4. BACKGROUND (Education, Employment, Family, Criminal history - include the provided history)
             5. KNOWN ASSOCIATES (Friends, family, criminal contacts)
             6. BEHAVIORAL ANALYSIS (How they handle stress, deception patterns, weaknesses)
             7. PRESSURE POINTS (Things that make them uncomfortable - include the dark secret)
             8. INTERROGATION NOTES (Recommended approach, potential pressure points)

             Make this person feel real with specific details, quirks, and believable background information. The dark secret should be woven naturally into their background. Format as an official police psychological assessment.`;

             const profile = await queryChatGPT(profilePrompt, 'suspect_profile');
             
             // Create pressure point keywords that will trigger stress
             const pressureKeywords = [
                 ...extractKeywordsFromSecret(selectedSecret),
                 ...extractKeywordsFromHistory(selectedHistory),
                 ...personalityType.slipUpTriggers
             ];
             
             return {
                 name,
                 isGuilty,
                 profile,
                 personalityType,
                 darkSecret: selectedSecret,
                 criminalHistory: selectedHistory,
                 pressurePoints: pressureKeywords,
                 stressTriggers: personalityType.slipUpTriggers,
                 currentStressLevel: 0,
                 slipUpThreshold: Math.random() * 30 + 50, // Between 50-80% stress
                 hasSlippedUp: false
             };
         }

         // Extract keywords from dark secrets and history for stress triggers
         function extractKeywordsFromSecret(secret) {
             const keywords = [];
             if (secret.includes('gambling')) keywords.push('gambling', 'money', 'debt', 'casino');
             if (secret.includes('affair')) keywords.push('marriage', 'wife', 'husband', 'relationship', 'cheating');
             if (secret.includes('embezzling')) keywords.push('money', 'work', 'employer', 'stealing', 'finances');
             if (secret.includes('violence')) keywords.push('anger', 'fight', 'hurt', 'violence', 'aggressive');
             if (secret.includes('drugs')) keywords.push('drugs', 'selling', 'addiction', 'medical');
             if (secret.includes('abuse')) keywords.push('childhood', 'family', 'anger', 'violence');
             if (secret.includes('lying')) keywords.push('education', 'job', 'credentials', 'truth');
             if (secret.includes('restraining')) keywords.push('ex', 'relationship', 'harassment', 'stalking');
             if (secret.includes('stealing')) keywords.push('family', 'money', 'theft', 'trust');
             if (secret.includes('mental')) keywords.push('health', 'medication', 'therapy', 'hospital');
             if (secret.includes('fraud')) keywords.push('insurance', 'money', 'scam', 'lying');
             if (secret.includes('blackmail')) keywords.push('secrets', 'money', 'threats', 'information');
             if (secret.includes('tax')) keywords.push('taxes', 'money', 'government', 'IRS');
             return keywords;
         }

         function extractKeywordsFromHistory(history) {
             const keywords = [];
             if (history.includes('shoplifting')) keywords.push('stealing', 'theft', 'arrest', 'teenager');
             if (history.includes('fights')) keywords.push('violence', 'anger', 'drinking', 'bar');
             if (history.includes('fired')) keywords.push('job', 'work', 'misconduct', 'employer');
             if (history.includes('rehab')) keywords.push('addiction', 'drugs', 'alcohol', 'treatment');
             if (history.includes('restraining')) keywords.push('harassment', 'stalking', 'ex', 'relationship');
             if (history.includes('fraud')) keywords.push('money', 'scam', 'investigation', 'charges');
             if (history.includes('evicted')) keywords.push('rent', 'money', 'home', 'payment');
             if (history.includes('mental health')) keywords.push('hospital', 'medication', 'therapy', 'illness');
             if (history.includes('driving')) keywords.push('drinking', 'alcohol', 'driving', 'arrest');
             if (history.includes('lawsuit')) keywords.push('legal', 'court', 'money', 'problems');
             if (history.includes('harassment')) keywords.push('work', 'women', 'inappropriate', 'complaints');
             if (history.includes('domestic')) keywords.push('violence', 'family', 'anger', 'abuse');
             if (history.includes('disturbance')) keywords.push('public', 'anger', 'police', 'arrest');
             if (history.includes('bankruptcy')) keywords.push('money', 'debt', 'financial', 'problems');
             if (history.includes('documents')) keywords.push('lying', 'fraud', 'official', 'truth');
             return keywords;
         }

                 // Enhanced interrogation response system with pressure points
         async function generateInterrogationResponse(question) {
             const personality = gameState.suspect.personalityType;
             const isGuilty = gameState.suspect.isGuilty;
             const stressLevel = gameState.stress;
             const questionLower = question.toLowerCase();
             
             // Check if question hits pressure points
             const pressurePointHit = gameState.suspect.pressurePoints?.some(keyword => 
                 questionLower.includes(keyword.toLowerCase())
             );

             // Determine behavioral context
             const behaviorContext = isGuilty ? 
                 personality.guiltyBehavior[Math.floor(Math.random() * personality.guiltyBehavior.length)] :
                 personality.innocentBehavior[Math.floor(Math.random() * personality.innocentBehavior.length)];

             const stressResponse = personality.stressResponses[Math.min(Math.floor(stressLevel / 25), personality.stressResponses.length - 1)];

             // Check for slip-up triggers
             const hasSlipUpTrigger = personality.slipUpTriggers.some(trigger => 
                 questionLower.includes(trigger.toLowerCase())
             );

             let responsePrompt = `You are ${gameState.suspect.name}, a ${personality.name} personality type.

             IMPORTANT BACKGROUND:
             - Dark Secret: ${gameState.suspect.darkSecret}
             - Criminal History: ${gameState.suspect.criminalHistory}
             - These are sensitive topics that make you uncomfortable and defensive

             Current Context:
             - Stress Level: ${stressLevel}%
             - Interrogation Phase: ${gameState.interrogationPhase}
             - Behavioral Pattern: ${behaviorContext}
             - Stress Response: ${stressResponse}
             - Question: "${question}"
             
             ${pressurePointHit ? `
             ⚠️ PRESSURE POINT HIT: This question touches on your sensitive areas (dark secret or history).
             Even if you're innocent of THIS crime, you're nervous about your secrets being exposed.
             React with increased anxiety, defensiveness, or deflection.
             ` : ''}
             
             ${isGuilty ? `
             You ARE guilty of the current crime and know these details: ${gameState.suspectKnowledge}
             
             Your dual challenge:
             1. Hide your guilt for THIS crime
             2. Keep your dark secrets hidden
             
             You may:
             - Lie about the crime while being defensive about personal matters
             - Show stress from both guilt AND embarrassment about your past
             - Make contradictions when overwhelmed by multiple pressures
             - Accidentally reveal crime details when distracted by personal questions
             ` : `
             You are INNOCENT of the current crime and don't know the crime details.
             
             However, you have secrets you don't want exposed:
             - Your dark secret makes you nervous and defensive
             - Your criminal history makes you look suspicious
             - You may seem guilty even though you're innocent of THIS crime
             
             React with:
             - Genuine confusion about the crime accusations
             - Defensive behavior about personal matters
             - Worry that your past makes you look guilty
             - Desire to help but fear of exposing your secrets
             `}

             ${hasSlipUpTrigger ? 'This question also triggers your personality-based stress responses!' : ''}
             
             Respond in character with realistic speech patterns, showing the complex emotions of someone with secrets being interrogated. Keep under 120 words.`;

                           return await queryChatGPT(responsePrompt, 'interrogation');
         }

        // Enhanced slip-up detection system
        function analyzeResponseForSlipUps(response, question) {
            const slipUpIndicators = {
                'knowledge_slip': /\b(I was|I did|I went|I saw|I heard)\b.*\b(there|then|that night|that time)\b/gi,
                'emotional_slip': /\b(sorry|apologize|didn't mean to|accident|mistake)\b/gi,
                'defensive_slip': /\b(prove it|you can't|no evidence|wasn't me)\b/gi,
                'detail_slip': /\b(exactly|precisely|specifically|remember clearly)\b.*\b(time|place|person)\b/gi,
                'contradiction': /\b(actually|wait|I mean|let me correct)\b/gi
            };

            let slipUpDetected = false;
            let slipUpType = '';

            // Check for trigger words in question
            const triggerWords = ['evidence', 'proof', 'witness', 'saw you', 'caught', 'found'];
            const hasStrongTrigger = triggerWords.some(trigger => 
                question.toLowerCase().includes(trigger)
            );

            // Analyze response for slip-ups
            Object.entries(slipUpIndicators).forEach(([type, regex]) => {
                const matches = response.match(regex);
                if (matches && matches.length > 0) {
                    gameState.slipUpCount++;
                    slipUpDetected = true;
                    slipUpType = type;
                    
                    // Increase stress based on slip-up severity
                    const stressIncrease = {
                        'knowledge_slip': 25,
                        'emotional_slip': 15,
                        'defensive_slip': 10,
                        'detail_slip': 20,
                        'contradiction': 30
                    }[type] || 10;
                    
                    gameState.stress += stressIncrease;
                    
                                         // Minimal feedback about behavioral changes
                     if (Math.random() < 0.4) {
                         addSystemMessage(`📊 Behavioral change detected`);
                     }
                }
            });

            // Check for major slip-up that could lead to confession
            if (gameState.stress > gameState.suspect.slipUpThreshold && !gameState.suspect.hasSlippedUp && Math.random() < 0.4) {
                gameState.suspect.hasSlippedUp = true;
                setTimeout(() => {
                    const confessionPrompt = `Generate a confession or major slip-up for ${gameState.suspect.name}. They've reached their breaking point under interrogation. Make it emotional and believable, revealing key details about the crime. Keep it under 150 words.`;
                    
                                         queryChatGPT(confessionPrompt, 'interrogation').then(confession => {
                         addChatMessage('suspect', confession);
                         gameState.stress = Math.min(100, gameState.stress + 40);
                         updateStressDisplay();
                         updateLiveFeed();
                     });
                }, 2000);
            }

            return { slipUpDetected, slipUpType };
        }

        // Enhanced chat system
        function addChatMessage(type, message) {
            const chatLog = document.getElementById('chatLog');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'user': '👮 DETECTIVE:',
                'suspect': '🎭 SUSPECT:',
                'system': '🖥️ SYSTEM:'
            }[type];
            
            messageDiv.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <strong>${prefix}</strong> ${message}`;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function addSystemMessage(message) {
            addChatMessage('system', message);
        }

        // Enhanced question processing
        async function askQuestion() {
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            if (!question) return;
            
            // Disable input while processing
            questionInput.disabled = true;
            document.querySelector('.ask-button').disabled = true;
            
            try {
                addChatMessage('user', question);
                
                // Generate response
                const response = await generateInterrogationResponse(question);
                addChatMessage('suspect', response);
                
                // Analyze response for behavioral markers
                const slipUpAnalysis = analyzeResponseForSlipUps(response, question);
                
                // Update game state
                gameState.chatHistory.push({ question, response, timestamp: Date.now() });
                
                // Update stress and phase
                updateStressFromQuestion(question);
                updateInterrogationPhase();
                updateStressDisplay();
                updateLiveFeed();
                
                // Clear input
                questionInput.value = '';
                
            } catch (error) {
                console.error('Question processing error:', error);
                addSystemMessage('❌ ERROR: Failed to process question');
            } finally {
                // Re-enable input
                questionInput.disabled = false;
                document.querySelector('.ask-button').disabled = false;
                questionInput.focus();
            }
        }

                 // Enhanced balanced stress system with pressure points
         function updateStressFromQuestion(question) {
             const questionLower = question.toLowerCase();
             let stressIncrease = 3; // Reduced base stress per question
             let pressurePointHit = false;
             let stressReason = "";

             // Check for pressure point keywords (higher stress increase)
             if (gameState.suspect.pressurePoints) {
                 gameState.suspect.pressurePoints.forEach(keyword => {
                     if (questionLower.includes(keyword.toLowerCase())) {
                         stressIncrease += 20; // Significant stress for pressure points
                         pressurePointHit = true;
                         stressReason = `Pressure point triggered: ${keyword}`;
                     }
                 });
             }

             // General interrogation stress factors (lower increases)
             const stressFactors = {
                 'evidence': 8,
                 'proof': 10,
                 'witness': 6,
                 'caught': 12,
                 'lie': 9,
                 'truth': 5,
                 'alibi': 7,
                 'where were you': 8,
                 'why did you': 10,
                 'confess': 15,
                 'guilty': 12,
                 'innocent': 5,
                 'arrest': 10,
                 'court': 8,
                 'prison': 12,
                 'family': 6,
                 'children': 8,
                 'job': 5,
                 'money': 7
             };

             // Only apply general stress if no pressure point was hit
             if (!pressurePointHit) {
                 Object.entries(stressFactors).forEach(([trigger, increase]) => {
                     if (questionLower.includes(trigger)) {
                         stressIncrease += increase;
                         if (!stressReason) stressReason = `General interrogation pressure: ${trigger}`;
                     }
                 });
             }

             // Apply personality modifier (more balanced)
             if (gameState.suspect.personalityType) {
                 const personalityModifier = {
                     'Narcissistic Manipulator': 0.9,  // Slightly resistant
                     'Anxious Pleaser': 1.3,           // More sensitive
                     'Cold Calculator': 0.7,           // Very resistant
                     'Defensive Aggressor': 1.1,       // Slightly more reactive
                     'Broken Victim': 1.4              // Most sensitive
                 }[gameState.suspect.personalityType.name] || 1.0;
                 
                 stressIncrease *= personalityModifier;
             }

             // Add some randomness to make it less predictable
             stressIncrease += Math.random() * 3 - 1.5; // ±1.5 random variance

             const finalIncrease = Math.max(1, Math.round(stressIncrease));
             gameState.stress = Math.min(100, gameState.stress + finalIncrease);
             gameState.contradictions++;

             // Provide minimal feedback about stress changes
             if (finalIncrease > 20 && Math.random() < 0.3) {
                 addSystemMessage(`📈 Subject showing signs of stress`);
             }
         }

        function updateStressDisplay() {
            document.getElementById('stressLevel').textContent = Math.round(gameState.stress);
            document.getElementById('stressFill').style.width = `${gameState.stress}%`;
        }

        function updateInterrogationPhase() {
            const newPhase = Math.min(8, Math.floor(gameState.stress / 12.5) + 1);
            if (newPhase !== gameState.interrogationPhase) {
                gameState.interrogationPhase = newPhase;
                document.getElementById('interrogationPhase').textContent = newPhase;
                
                // Minimal phase change notification
                if (newPhase >= 6 && Math.random() < 0.5) {
                    addSystemMessage(`📊 Interrogation phase ${newPhase}`);
                }
            }
        }

                 // Enhanced live feed
         function updateLiveFeed() {
             const cam = document.getElementById('suspectCam');
             const time = new Date().toLocaleTimeString();
             const stressStatus = getEnhancedStressStatus();
             
             // Calculate background stress indicators
             const backgroundStress = gameState.suspect?.pressurePoints ? 'DETECTED' : 'SCANNING';
             const vulnerabilityLevel = gameState.stress > 60 ? 'HIGH' : gameState.stress > 30 ? 'MODERATE' : 'LOW';
             
             cam.innerHTML = `
[LIVE FEED: INTERROGATION ROOM 3A]
[ENHANCED MONITORING SYSTEM ACTIVE]

> SUBJECT: ${gameState.suspect?.name || 'Unknown'}
> STATUS: ${stressStatus}
> STRESS: ${Math.round(gameState.stress)}%
> PHASE: ${gameState.interrogationPhase}/8
> PERSONALITY: ${gameState.suspect?.personalityType?.name || 'Analyzing...'}
> VULNERABILITY: ${vulnerabilityLevel}
> BACKGROUND ISSUES: ${backgroundStress}
> SLIP-UPS: ${gameState.slipUpCount}
> TIMESTAMP: ${time}

${'█'.repeat(Math.floor(gameState.stress / 3))}${'▒'.repeat(Math.max(0, 33 - Math.floor(gameState.stress / 3)))}

[BEHAVIORAL ANALYSIS: ACTIVE]
[PRESSURE POINT DETECTION: ENABLED]
[PSYCHOLOGICAL PROFILING: RUNNING]
[DECEPTION ANALYSIS: MONITORING]
             `;
         }

        function getEnhancedStressStatus() {
            if (gameState.stress > 90) return '🔴 CRITICAL - BREAKDOWN IMMINENT';
            if (gameState.stress > 75) return '🟠 SEVERE - HIGH STRESS';
            if (gameState.stress > 50) return '🟡 ELEVATED - AGITATED';
            if (gameState.stress > 25) return '🟢 MODERATE - TENSE';
            return '🔵 LOW - CALM';
        }

        // Enhanced initialization
        async function initializeGame() {
            try {
                addSystemMessage('🔄 Initializing enhanced interrogation system...');
                
                // Generate crime and suspect
                const suspectName = SUSPECT_NAMES[Math.floor(Math.random() * SUSPECT_NAMES.length)];
                
                addSystemMessage('📋 Generating case file...');
                gameState.crime = await generateEnhancedCrime();
                
                addSystemMessage('👤 Creating suspect profile...');
                gameState.suspect = await generateEnhancedSuspect(suspectName);
                gameState.personalityType = gameState.suspect.personalityType;
                
                // If guilty, create knowledge base
                if (gameState.suspect.isGuilty) {
                    gameState.suspectKnowledge = gameState.crime;
                }
                
                // Setup UI
                displayCaseSummary();
                updatePersonalityIndicator();
                startTimer();
                updateLiveFeed();
                updateStressDisplay();
                
                // Make windows draggable
                makeDraggable(document.getElementById('caseFile'));
                makeDraggable(document.getElementById('suspectFile'));
                makeDraggable(document.getElementById('evidenceFile'));
                
                                                 addSystemMessage('✅ System ready - Begin interrogation');
                setupKeyboardSupport();
                
                // Ensure input box is visible and focused
                const questionInput = document.getElementById('questionInput');
                if (questionInput) {
                    questionInput.style.display = 'block';
                    questionInput.disabled = false;
                    questionInput.focus();
                } else {
                    addSystemMessage('❌ ERROR: Question input not found');
                }
                 
             } catch (error) {
                 console.error('Initialization error:', error);
                 addSystemMessage('❌ System initialization failed - Check console');
             }
        }

                         function updatePersonalityIndicator() {
            const indicator = document.getElementById('personalityIndicator');
            if (gameState.personalityType && gameState.suspect) {
                indicator.innerHTML = `
                    <strong>PSYCHOLOGICAL PROFILE:</strong> ${gameState.personalityType.name}<br>
                    <strong>OBSERVED TRAITS:</strong> ${gameState.personalityType.traits.join(', ')}
                `;
            }
        }

        function displayCaseSummary() {
            const summary = gameState.crime.substring(0, 800) + '...';
            document.getElementById('crimeSummary').innerHTML = `<pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 10px;">${summary}</pre>`;
        }

        // File toggle functions - Detective access to case information
        function toggleCaseFile() {
            const cf = document.getElementById('caseFile');
            const isShowing = cf.style.display === 'block';
            cf.style.display = isShowing ? 'none' : 'block';
            
            if (!isShowing && gameState.crime) {
                document.getElementById('caseFileContent').innerHTML = `
                    <div style="font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4;">
                        <h3 style="color: #000080; margin-top: 0;">OFFICIAL CASE FILE</h3>
                        <pre style="white-space: pre-wrap; margin: 0; word-wrap: break-word;">${gameState.crime}</pre>
                    </div>
                `;
            }
        }

        function toggleSuspectFile() {
            const sf = document.getElementById('suspectFile');
            const isShowing = sf.style.display === 'block';
            sf.style.display = isShowing ? 'none' : 'block';
            
            if (!isShowing) {
                sf.style.left = '40%';
                sf.style.top = '30%';
                updateSuspectFile();
            }
        }

        function toggleEvidenceFile() {
            const ef = document.getElementById('evidenceFile');
            const isShowing = ef.style.display === 'block';
            ef.style.display = isShowing ? 'none' : 'block';
            
            if (!isShowing) {
                ef.style.left = '30%';
                ef.style.top = '40%';
                updateEvidenceFile();
            }
        }

        function updateSuspectFile() {
            const content = document.getElementById('suspectFileContent');
            if (gameState.suspect && gameState.suspect.profile) {
                content.innerHTML = `
                    <div style="font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4;">
                        <h3 style="color: #000080; margin-top: 0;">SUSPECT BACKGROUND</h3>
                        <pre style="white-space: pre-wrap; margin: 0; word-wrap: break-word;">${gameState.suspect.profile}</pre>
                    </div>
                `;
            } else {
                content.innerHTML = '<p>Suspect profile loading...</p>';
            }
        }

        function updateEvidenceFile() {
            const content = document.getElementById('evidenceFileContent');
            if (gameState.crime) {
                // Extract evidence section from crime file
                const evidenceMatch = gameState.crime.match(/(?:PHYSICAL EVIDENCE|Evidence|EVIDENCE)([\s\S]*?)(?=WITNESS|Witness|SUSPECT|INVESTIGATIVE|$)/i);
                const witnessMatch = gameState.crime.match(/(?:WITNESS STATEMENTS|Witness|WITNESSES)([\s\S]*?)(?=SUSPECT|INVESTIGATIVE|NOTES|$)/i);
                
                let evidenceContent = '';
                if (evidenceMatch) {
                    evidenceContent += `<h4>PHYSICAL EVIDENCE:</h4><pre>${evidenceMatch[1].trim()}</pre>`;
                }
                if (witnessMatch) {
                    evidenceContent += `<h4>WITNESS STATEMENTS:</h4><pre>${witnessMatch[1].trim()}</pre>`;
                }
                
                content.innerHTML = `
                    <div style="font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4;">
                        <h3 style="color: #000080; margin-top: 0;">EVIDENCE LOCKER</h3>
                        ${evidenceContent || '<p>No evidence data available in current format.</p>'}
                    </div>
                `;
            } else {
                content.innerHTML = '<p>Evidence analysis in progress...</p>';
            }
        }

        // Timer and game flow
        function startTimer() {
            const timerInterval = setInterval(() => {
                gameState.timer--;
                const minutes = Math.floor(gameState.timer / 60);
                const seconds = gameState.timer % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (gameState.timer <= 0) {
                    clearInterval(timerInterval);
                    endInterrogation();
                }
                
                // Periodic stress increase due to time pressure
                if (gameState.timer % 30 === 0 && gameState.timer < 300) {
                    gameState.stress = Math.min(100, gameState.stress + 2);
                    updateStressDisplay();
                }
                
                updateLiveFeed();
            }, 1000);
        }

        function endInterrogation() {
            document.getElementById('questionInput').disabled = true;
            document.querySelector('.ask-button').disabled = true;
            
            addSystemMessage('⏰ TIME EXPIRED - Proceeding to assessment phase');
            
            const dialog = document.getElementById('verdictDialog');
            document.getElementById('finalStress').textContent = Math.round(gameState.stress);
            document.getElementById('finalContradictions').textContent = gameState.contradictions;
            document.getElementById('finalPhase').textContent = gameState.interrogationPhase;
            document.getElementById('finalPersonality').textContent = gameState.personalityType?.name || 'Unknown';
            document.getElementById('verdictResult').textContent = '';
            dialog.style.display = 'block';
        }

        function checkVerdict(userChoice) {
            const resultElement = document.getElementById('verdictResult');
            const correct = userChoice === gameState.suspect.isGuilty;
            
            document.getElementById('activeVerdictButtons').style.display = 'none';
            
            if (correct) {
                resultElement.innerHTML = `
                    <div style="color: #000080; font-size: 16px; margin: 10px 0;">
                        ✅ CORRECT ASSESSMENT ✅
                    </div>
                    <div style="font-size: 12px;">
                        Subject was indeed <strong>${gameState.suspect.isGuilty ? 'GUILTY' : 'INNOCENT'}</strong><br>
                        Personality Type: ${gameState.personalityType.name}<br>
                        Stress Analysis: ${Math.round(gameState.stress)}% final stress level<br>
                        Behavioral Markers: ${gameState.contradictions} detected<br>
                        Slip-ups Recorded: ${gameState.slipUpCount}<br>
                        <br>
                        <strong>Excellent detective work!</strong>
                    </div>
                `;
            } else {
                resultElement.innerHTML = `
                    <div style="color: #800000; font-size: 16px; margin: 10px 0;">
                        ❌ INCORRECT DETERMINATION ❌
                    </div>
                    <div style="font-size: 12px;">
                        Subject was actually <strong>${gameState.suspect.isGuilty ? 'GUILTY' : 'INNOCENT'}</strong><br>
                        Personality Type: ${gameState.personalityType.name}<br>
                        You were misled by: ${gameState.personalityType.name} behavioral patterns<br>
                        Final Stress: ${Math.round(gameState.stress)}%<br>
                        <br>
                        <strong>Study the personality profiles for better results.</strong>
                    </div>
                `;
                
                gameState.lives--;
                updateLivesDisplay();
                
                if (gameState.lives <= 0) {
                    document.getElementById('verdictDialog').style.display = 'none';
                    document.getElementById('gameOverScreen').style.display = 'block';
                    return;
                }
            }

            document.getElementById('nextCaseButton').style.display = 'block';
        }

        function handleNextCase() {
            document.getElementById('verdictDialog').style.display = 'none';
            document.getElementById('nextCaseButton').style.display = 'none';
            document.getElementById('activeVerdictButtons').style.display = 'flex';
            restartGame();
        }

        function restartGame() {
            // Reset game state but keep lives
            const currentLives = gameState.lives;
            gameState = {
                lives: currentLives,
                crime: null,
                suspect: null,
                contradictions: 0,
                stress: 0,
                timer: 600,
                chatHistory: [],
                interrogationPhase: 1,
                personalityType: null,
                slipUpCount: 0,
                evidenceRevealed: [],
                suspectKnowledge: null
            };
            
                         // Clear UI
             document.getElementById('chatLog').innerHTML = '';
             document.getElementById('questionInput').disabled = false;
             document.querySelector('.ask-button').disabled = false;
             
             // Restart
             setupKeyboardSupport();
             initializeGame();
        }

        function updateLivesDisplay() {
            const lives = ['life1', 'life2', 'life3'];
            lives.forEach((lifeId, index) => {
                const life = document.getElementById(lifeId);
                life.classList.toggle('lost', index >= gameState.lives);
            });
        }

        // Draggable functionality
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const titleBar = element.querySelector('.draggable');
            
            if (titleBar) {
                titleBar.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                element.style.zIndex = 1001;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function startGame() {
            document.getElementById('introPopup').style.display = 'none';
            initializeGame();
            updateLivesDisplay();
        }

                 // Enhanced keyboard support
         function setupKeyboardSupport() {
             const questionInput = document.getElementById('questionInput');
             if (questionInput) {
                 // Remove any existing listeners
                 questionInput.removeEventListener('keydown', handleKeyDown);
                 questionInput.removeEventListener('keypress', handleKeyPress);
                 
                 // Add new listeners
                 questionInput.addEventListener('keydown', handleKeyDown);
                 questionInput.addEventListener('keypress', handleKeyPress);
             }
         }

         function handleKeyDown(e) {
             if (e.key === 'Enter' && !e.shiftKey) {
                 e.preventDefault();
                 askQuestion();
             }
         }

         function handleKeyPress(e) {
             if (e.key === 'Enter' && !e.shiftKey) {
                 e.preventDefault();
             }
         }

        // Initial setup
        makeDraggable(document.getElementById('introPopup'));
        document.getElementById('introPopup').style.display = 'block';
    </script>
</body>
</html>